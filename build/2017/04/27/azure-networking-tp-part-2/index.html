<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    
    <link rel="stylesheet" href="/css/style.css" type="text/css">
    

    <title>XYZ Blog</title>
    <script defer src="https://use.fontawesome.com/releases/v5.7.2/js/all.js" integrity="sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    
      <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js"></script>
    

    <script src="/js/script.js"></script>
    </head>
  <body class="position-relative" data-spy="scroll" data-target=".site-nav" data-offset="55">
    <nav class="site-nav family-sans navbar navbar-expand-md navbar-dark  sidebar sticky-top  py-0">
  <div class="container-fluid">
    <button type="button" class="navbar-toggler my-2 my-md-0" data-toggle="collapse" data-target="#myTogglerNav" aria-controls="myTogglerNav" aria-label="Toggle Navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="navbar-brand text-uppercase">
      <a class="text-light" href="/"><i class="fas fa-cube mr-2"></i>XYZ Blog</a> 
    </div>

    <div class="collapse navbar-collapse text-center mt-0" id="myTogglerNav">
      <div class="navbar-nav ml-auto font-weight-regular text-uppercase">
        
        <a class="d-none nav-item nav-link" href="#page-hero">hero target</a>
        <a class="d-none nav-item nav-link" href="#main-content">nav target</a>
        
        <a class="nav-item nav-link font-weight-bold  text-light" href="/"><i class="fas fa-home"></i></a>
        
          <a class="nav-item nav-link" href="/courses/0/">courses</a>
          
          <a class="nav-item nav-link" href="/posts/0/">posts</a>
          <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Projects
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">




          <a class="dropdown-item text-capitalize text-normal" href="/projects/seven/"><i class="fas fa-atom"></i> seven</a><a class="dropdown-item text-capitalize text-normal" href="/projects/rayveal/"><i class="fas fa-atom"></i> rayveal</a></div>
        </div>
        <div class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fas fa-user"></i>
          </a>
          <div class="dropdown-menu dropdown-menu-right" aria-labelledby="userDropdown">
            <a class="dropdown-item text-capitalize" href="/about">About Me</a>
            <div class="dropdown-divider"></div><a class="dropdown-item text-capitalize" target="_blank" href="https://github.com/etiennedeneuve">
            <i class="fab fa-github text-secondary mr-2"></i>github
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://linkedin.com/in/etiennedeneuve">
            <i class="fab fa-linkedin text-secondary mr-2"></i>linkedin
          </a><a class="dropdown-item text-capitalize" target="_blank" href="https://twitter.com/etiennedinfo">
            <i class="fab fa-twitter text-secondary mr-2"></i>twitter
          </a></div>
        </div>
      </div>
      <div class="searchbox pl-2 py-2">
    <input
      type="text"
      v-model="query"
      class="form-control text-white border m-auto"
      :class="[isActive ? 'wide' : 'short']"
      @focus="isActive=true"
      @blur.prevent="handleBlur"
      ref="searchinput"
      style="background: transparent;"
      aria-describedby="searchinput"
      autocomplete="off"
    >
    <div v-if="query && isActive" class="position-absolute justify-content-center" style="top: 47px;">
      <div class="card bg-secondary">
        <ul class="list-group list-group-flush px-0" v-for="(item, index) in queried" :key="index">
          <li class="list-group-item">
            <a :href="item.url" class="d-flex text-secondary">
              <span class="pr-2" v-html="item.icon"></span>
              <span class="text-body text-left" v-html="item.title"></span>
            </a>
          </li>
        </ul>
      </div>
    </div>
</div>
    </div>
  </div>
</nav>

      

 
  <div class="post post-sidebar container-fluid">
    <div class="row justify-content-xl-center">
      <aside class="aside aside-main d-none d-md-block col-md-3 col-lg-2">
        <nav class="sticky-top list-group list-group-flush text-right" id="collapseExample">

          </nav>
      </aside>


      <main class="main col">
      <p><a href="https://www.linkedin.com/in/lopesmickael">Mickael Lopes</a> et moi avons animé une session au Global Azure Bootcamp intitulée : &quot;Le réseau dans Azure : Cas d'usage et Retour d'expériences&quot;.<br>
Les slides de  notre session sont dispo sur slideshare ici : <a href="https://www.slideshare.net/MickaelLOPES91/gab-le-rseau-dans-azure">Slideshare de Mickael</a><br>
Comme prévu, voici des TP pour aller avec notre présentation, a faire vous même :)<br>
Ce post est la suite de la partie 1, qui part du principe que vous avez déjà la partie 1 de faite sur votre tenant, dans toutes les versions (Powershell, Azure Cli 2.0 et ARM Template).</p>
<h1>vNet Peering</h1>
L'objectif est de connecter nos 3 Vnets, avec nos 3 outils :
<ul>
 	<li>vnet-test-ps</li>
 	<li>vnet-test-az</li>
 	<li>vnet-test-json</li>
</ul>
<h2>Powershell</h2>
Nous allons créer le lien entre vnet-test-ps et vnet-test-az :
<pre><code class="lang-powershell"><span class="hljs-variable">$vnetPS</span> = <span class="hljs-pscommand">Get-AzureRmVirtualNetwork</span><span class="hljs-parameter"> -ResourceGroupName RG-Vnet-Exo-PS<span class="hljs-parameter"> -Name </span>vnet-test-ps</span>
<span class="hljs-variable">$vnetAZ</span> = <span class="hljs-pscommand">Get-AzureRmVirtualNetwork</span><span class="hljs-parameter"> -ResourceGroupName RG-Vnet-Exo-AZ -Name </span>vnet-test-az</code></pre>
Puis nous créons le lien PS2AZ :
<pre><code class="lang-powershell"><span class="hljs-pscommand">Add-AzureRmVirtualNetworkPeering</span><span class="hljs-parameter"> -Name </span>PS2AZ<span class="hljs-parameter"> -VirtualNetwork </span><span class="hljs-variable">$vnetPS</span><span class="hljs-parameter"> -RemoteVirtualNetworkId </span><span class="hljs-variable">$vnetAZ</span>.Id
</code></pre>
<pre><code class="lang-powershell"><span class="hljs-pscommand">Add-AzureRmVirtualNetworkPeering</span><span class="hljs-parameter"> -Name </span>AZ2PS<span class="hljs-parameter"> -VirtualNetwork </span><span class="hljs-variable">$vnetAZ</span><span class="hljs-parameter"> -RemoteVirtualNetworkId </span><span class="hljs-variable">$vnetPS</span>.Id</code></pre>
nous pouvons vérifié si le peering est fonctionnel via la commande Powershell :
<pre><code class="lang-powershell"> <span class="hljs-pscommand">Get-AzureRmVirtualNetworkPeering</span><span class="hljs-parameter"> -VirtualNetworkName </span>vnetPS<span class="hljs-parameter"> -ResourceGroupName </span>vnetPS<span class="hljs-parameter"> -Name </span>PS2AZ</code></pre>
en l'état, notre peering est configuré mais certaines options ne sont pas activées :
<ul>
 	<li>Forwarded Traffic</li>
 	<li>Gateway Transit</li>
 	<li>Remote Gateways</li>
</ul>
Dans notre cas, nous avons besoin d'activer le transfert du trafic.
<pre><code class="lang-powershell">$ps2az = <span class="hljs-pscommand">Get-AzureRmVirtualNetworkPeering</span><span class="hljs-parameter"> -VirtualNetworkName </span>vnetPS<span class="hljs-parameter"> -ResourceGroupName </span>vnetPS<span class="hljs-parameter"> -Name </span>PS2AZ
<span class="hljs-variable">$</span>ps2az.AllowForwardedTraffic = <span class="hljs-literal">$true
</span><span class="hljs-pscommand">Set-AzureRmVirtualNetworkPeering</span><span class="hljs-parameter"> -VirtualNetworkPeering </span><span class="hljs-variable">$</span>ps2az</code></pre>
<h2>Azure CLI 2.0</h2>
Avec Azure CLI, il faudra recupéré l'id du réseau distant pour le peering avec la commande :
<pre><code class="lang-bash">az network vnet list -g RG-Vnet-Exo-JSON</code></pre>
et vous recuperez un objets json, cherchez votre id qui sera du type :
[code]/subscriptions/VOTREIDDESOUSCRPTION/resourceGroups/RG-Vnet-Exo-JSON/providers/Microsoft.Network/virtualNetworks/vnet-test-json[/code]
<p>Si vous utilisez le bash (Ubuntu on Windows par exemple) créer une variable comme ceci :</p>
<pre><code class="lang-bash">JSON_VNET_ID="/subscriptions/VOTREIDDESOUSCRPTION/resourceGroups/RG-Vnet-Exo-JSON/providers/Microsoft.Network/virtualNetworks/vnet-test-json"</code></pre>
<p>Ce sera beaucoup plus simple pour l'appeler dans la commande suivante :</p>
<pre><code class="lang-bash"> az network vnet peering create --name AZ2JSON \
   --remote-vnet-id ${$JSON_VNET_ID} \
   --resource-group RG-Vnet-Exo-AZ \
   --vnet-name vnet-test-az \ 
   --allow-forwarded-traffic \
   --allow-vnet-access \
</code></pre>
<p>Théoriquement, nous pourrions executer la commande pour effectuer le peering dans l'autre sens, mais nous allons la faire avec notre template de la partie 1.</p>
<h2>ARM Template</h2>
Pour déclarer un vnet peering dans un template ARM, à l'heure actuelle, via le portail ou la ligne de commande (Powershell ou Azure CLI 2.0) il n'est pas possible dans le "contexte" de manipuler deux Resource Group. Du coup, il faut le faire d'un coté puis de l'autre, ou utiliser des templates "nested" c'est à dire un template "parent" puis deux "enfants". Nous n'allons (pas encore ;)) aborder ce type de template. (Stay Tuned !)
<p>Donc, reprenons notre template et ajoutons un nouveau type de resource Azure &quot;Microsoft.Network/virtualNetworks/virtualNetworkPeerings&quot;</p>
<pre><code class="lang-json">{
"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
"contentVersion": "1.0.0.0",
"parameters": {
"vnetname": {
"type": "string",
"metadata": {
"description": "Nom du Vnet"
},
"defaultValue": "vnet-test-json"
},
"vNetRemote": {
"type": "string",
"metadata": {
"description": "Nom du Vnet distant"
},
"defaultValue": "vnet-test-az"
},
"RGvNetRemote": {
"type": "string",
"metadata": {
"description": "Nom du Resource Group"
},
"defaultValue": "RG-Vnet-Exo-AZ"
},
"addressSpacePrefix": {
"type": "string",
"metadata": {
"description": "IP v4 (RFC1918)"
},
"defaultValue": "10.0.2.0/24"
},
"subnetName": {
"type": "string",
"metadata": {
"description": "Nom du Subnet"
},
"defaultValue": "jsonfrontend"
},
"subnetPrefix": {
"type": "string",
"metadata": {
"description": "IP v4 du Subnet"
},
"defaultValue": "10.0.2.0/26"
}
},
"variables": {},
"resources": [
{
"apiVersion": "2015-06-15",
"type": "Microsoft.Network/virtualNetworks",
"name": "[parameters('VnetName')]",
"location": "[resourceGroup().location]",
"tags": {
"displayName": "JSON-VNET"
},
"properties": {
"addressSpace": {
"addressPrefixes": [
"[parameters('addressSpacePrefix')]"
]
},
"subnets": [
{
"name": "[parameters('subnetName')]",
"properties": {
"addressPrefix": "[parameters('subnetPrefix')]"
}
}
]
}
},
{
"apiVersion": "2017-03-01",
"type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
"name": "[concact( parameters('VnetName') , '/JSON2AZ')]",
"location": "[resourceGroup().location]",
"properties": {
"allowVirtualNetworkAccess": true,
"allowForwardedTraffic": true,
"allowGatewayTransit": false,
"useRemoteGateways": false,
"remoteVirtualNetwork": {
"id": "[resourceId( subscription().subscriptionid, parameters('RGvNetRemote') , 'Microsoft.Network/virtualNetworks', parameters('vNetRemote'))]"
}
}
}
],
"outputs": {}
}</code></pre>
<p>La méthode de déploiement reste la même que dans la partie 1.</p>

      </main>
      <aside class="aside aside-supplemental d-none d-lg-block col-lg-2 col-xl-2" >
        <nav class="sticky-top">
        
        </nav>
      </aside>
    </div>
  </div>
</div>

    <footer class="site-footer bg-transparent pb-3 pb-md-5">
      <div class="layout-social container d-flex justify-content-center">

  

  

  

  

  

  

  

</div>
    </footer>
  </body>

</html>